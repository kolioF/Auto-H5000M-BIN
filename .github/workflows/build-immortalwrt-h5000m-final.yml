name: 'ğŸš€ ImmortalWrt H5000M æ™ºèƒ½æ„å»ºç³»ç»Ÿ v5'

on:
  workflow_dispatch:
    inputs:
      enable_adguardhome:
        description: 'å¯ç”¨ AdGuardHome (å¹¿å‘Šæ‹¦æˆª)'
        required: false
        type: boolean
        default: true
      enable_openclash:
        description: 'å¯ç”¨ OpenClash (ä»£ç†å·¥å…·)'
        required: false
        type: boolean
        default: false
      enable_mihomo:
        description: 'å¯ç”¨ Mihomo (ä»£ç†å·¥å…·)'
        required: false
        type: boolean
        default: false
      enable_upnp:
        description: 'å¯ç”¨ UPnP (ç«¯å£æ˜ å°„)'
        required: false
        type: boolean
        default: true
      enable_vlmcsd:
        description: 'å¯ç”¨ VLMCSd (KMSæ¿€æ´»æœåŠ¡)'
        required: false
        type: boolean
        default: false
      enable_mosdns:
        description: 'å¯ç”¨ MosDNS (DNSæœåŠ¡)'
        required: false
        type: boolean
        default: false
      enable_dockerman:
        description: 'å¯ç”¨ DockerMan (Dockerç®¡ç†)'
        required: false
        type: boolean
        default: false
      enable_qmodem_next:
        description: 'å¯ç”¨ QModem Next (5Gç®¡ç†æ–°ç‰ˆ)'
        required: false
        type: boolean
        default: true
      enable_qmodem:
        description: 'å¯ç”¨ QModem (5Gç®¡ç†æ—§ç‰ˆ)'
        required: false
        type: boolean
        default: false
      enable_mwan:
        description: 'å¯ç”¨ MWAN (å¤šWANè´Ÿè½½å‡è¡¡)'
        required: false
        type: boolean
        default: true
      max_build_time:
        description: 'æœ€å¤§ç¼–è¯‘æ—¶é—´(åˆ†é’Ÿ)'
        required: false
        type: number
        default: 150

# æ·»åŠ æƒé™å£°æ˜
permissions:
  contents: write

env:
  REPO_URL: 'https://github.com/immortalwrt/immortalwrt'
  REPO_BRANCH: 'openwrt-24.10'
  CONFIG_URL: 'https://raw.githubusercontent.com/padavanonly/immortalwrt-mt798x-6.6/refs/heads/mt798x-mt799x-6.6-mtwifi/defconfig/mt7987_mt7992.config'
  CONFIG_FILE: 'mt7987_mt7992.config'
  SOURCE_DIR: 'immortalwrt'
  TZ: 'Asia/Shanghai'

jobs:
  analyze:
    name: ğŸ” æ™ºèƒ½åˆ†æ
    runs-on: ubuntu-24.04
    outputs:
      config-hash: ${{ steps.config-hash.outputs.hash }}
      use-incremental: ${{ steps.decision.outputs.use-incremental }}
      build-strategy: ${{ steps.decision.outputs.build-strategy }}
      clean-level: ${{ steps.decision.outputs.clean-level }}
      optimal-threads: ${{ steps.decision.outputs.optimal-threads }}
      needs-rebuild: ${{ steps.decision.outputs.needs-rebuild }}
      disk-space: ${{ steps.disk-check.outputs.disk-space }}
    steps:
      - name: ğŸ›’ ç­¾å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ—‚ï¸ æ·±åº¦ç£ç›˜æ¸…ç†
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "========== æ¸…ç†å‰ç£ç›˜ç©ºé—´ =========="
          df -h

          # åˆ é™¤ Docker é•œåƒå’Œå®¹å™¨
          docker rmi $(docker images -q) 2>/dev/null || true
          docker system prune -af --volumes 2>/dev/null || true
          sudo systemctl stop docker 2>/dev/null || true
          sudo systemctl disable docker 2>/dev/null || true

          # åˆ é™¤ä¸éœ€è¦çš„å¤§å‹ç»„ä»¶ï¼ˆåŸºäº build.ymlï¼‰
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android \
            /opt/ghc /etc/mysql /etc/php /usr/local/share/boost /usr/share/swift \
            /opt/hostedtoolcache /usr/local/.ghcup /usr/local/graalvm /imagegeneration \
            /usr/share/gradle /usr/local/share/node /opt/azul* 2>/dev/null || true

          # å¸è½½ä¸éœ€è¦çš„è½¯ä»¶ï¼ˆåŸºäº build.ymlï¼‰
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* \
            google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* \
            mongodb* moby* snap* android* chrome* chromium* thunderbird* libreoffice* \
            eclipse* netbeans* intellij* virtualbox* vagrant* kubectl* helm* awscli* \
            packer* terraform* ansible* chef* puppet* salt* minikube* skaffold* kustomize* \
            htop* neofetch* screen* tmux* vim* emacs* nano* || true

          # é¢å¤–æ¸…ç†
          sudo rm -rf /usr/local/lib/node* /usr/local/go /opt/mssql-tools /opt/mssql \
            /usr/share/java /usr/lib/jvm /opt/selenium /opt/sonar-scanner 2>/dev/null || true

          # æ¸…ç†åŒ…ç¼“å­˜å’Œç³»ç»Ÿæ–‡ä»¶
          sudo -E apt-get -qq update
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq autoclean
          sudo -E apt-get -qq clean

          # æ¸…ç†ç³»ç»Ÿæ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶
          sudo journalctl --vacuum-time=1d
          sudo rm -rf /tmp/* /var/tmp/* /var/log/* /var/cache/apt/archives/*.deb 2>/dev/null || true
          sudo find /var/log -type f -name "*.log" -delete 2>/dev/null || true
          sudo rm -rf /usr/share/man /usr/share/doc /usr/share/info 2>/dev/null || true

          # æ¸…ç†è¯­è¨€åŒ…
          sudo locale-gen --purge en_US.UTF-8 2>/dev/null || true
          sudo apt-get -y purge language-pack-* 2>/dev/null || true

          # æ¸…ç†ä¸å¿…è¦çš„å†…æ ¸å’Œæ¨¡å—
          sudo apt-get -y purge linux-headers-* linux-image-extra-* 2>/dev/null || true

          # è®¾ç½®æ—¶åŒº
          sudo timedatectl set-timezone "$TZ"

          # åˆ›å»ºå·¥ä½œç›®å½•
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

          echo "========== æ¸…ç†åç£ç›˜ç©ºé—´ =========="
          df -h

          # éªŒè¯ç©ºé—´
          AVAIL_GB=$(df -BG / | tail -1 | awk '{print int($4)}')
          echo "ğŸ–¥ï¸ Runner: $(nproc) cores, $(free -g | awk '/Mem:/{print $2}')GB RAM"
          echo "ğŸ’¾ å¯ç”¨ç£ç›˜ç©ºé—´: ${AVAIL_GB}GB"

      - name: ğŸ“Š ç£ç›˜ç©ºé—´æ£€æµ‹
        id: disk-check
        run: |
          AVAILABLE_SPACE=$(df / | awk 'NR==2 {print $4}')
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))

          echo "å¯ç”¨ç£ç›˜ç©ºé—´: ${AVAILABLE_GB}GB"

          if [ $AVAILABLE_GB -lt 20 ]; then
            echo "disk-space=critical" >> $GITHUB_OUTPUT
            echo "ğŸš¨ ç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³ (${AVAILABLE_GB}GB)"
          elif [ $AVAILABLE_GB -lt 30 ]; then
            echo "disk-space=low" >> $GITHUB_OUTPUT
            echo "âš ï¸ ç£ç›˜ç©ºé—´ç´§å¼  (${AVAILABLE_GB}GB)"
          elif [ $AVAILABLE_GB -lt 45 ]; then
            echo "disk-space=medium" >> $GITHUB_OUTPUT
            echo "ğŸ”„ ç£ç›˜ç©ºé—´ä¸­ç­‰ (${AVAILABLE_GB}GB)"
          else
            echo "disk-space=sufficient" >> $GITHUB_OUTPUT
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³ (${AVAILABLE_GB}GB)"
          fi

      - name: ğŸ—ï¸ ç”Ÿæˆé…ç½®å“ˆå¸Œ
        id: config-hash
        run: |
          # ç”Ÿæˆå®Œæ•´é…ç½®å“ˆå¸Œ
          CONFIG_CONTENT=""

          # æ·»åŠ åŸºç¡€é…ç½®
          [ -f "h5000m.extra.config" ] && CONFIG_CONTENT+="$(cat h5000m.extra.config)"
          [ -f "feeds.conf.default" ] && CONFIG_CONTENT+="$(cat feeds.conf.default)"

          # æ·»åŠ ç”¨æˆ·è¾“å…¥
          CONFIG_CONTENT+="${{ toJson(inputs) }}"

          # ç”Ÿæˆå“ˆå¸Œ
          HASH=$(echo "$CONFIG_CONTENT" | sha256sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "ğŸ” é…ç½®å“ˆå¸Œ: $HASH"

      - name: ğŸ§  æ™ºèƒ½å†³ç­–
        id: decision
        run: |
          echo "::group::ğŸ§  æ™ºèƒ½æ„å»ºå†³ç­–"

          DISK_SPACE="${{ steps.disk-check.outputs.disk-space }}"
          CACHE_SCORE=0

          # æ ¹æ®ç£ç›˜ç©ºé—´è°ƒæ•´ç¼“å­˜è¯„åˆ†
          case "$DISK_SPACE" in
            "sufficient")
              CACHE_SCORE=70
              ;;
            "medium")
              CACHE_SCORE=50
              ;;
            "low")
              CACHE_SCORE=30
              ;;
            "critical")
              CACHE_SCORE=10
              ;;
          esac

          echo "ğŸ“Š ç¼“å­˜è¯„åˆ†: $CACHE_SCORE/100 (ç£ç›˜çŠ¶æ€: $DISK_SPACE)"

          # å†³ç­–é€»è¾‘
          if [ $CACHE_SCORE -ge 60 ]; then
            BUILD_STRATEGY="full-cache"
            USE_INCREMENTAL="true"
            CLEAN_LEVEL="none"
            THREADS=$(( $(nproc) < 8 ? $(nproc) : 8 ))
            echo "âœ… å†³ç­–: å…¨ç¼“å­˜å¢é‡æ„å»º"
          elif [ $CACHE_SCORE -ge 40 ]; then
            BUILD_STRATEGY="partial-cache"
            USE_INCREMENTAL="false"
            CLEAN_LEVEL="minimal"
            THREADS=$(( $(nproc) < 6 ? $(nproc) : 6 ))
            echo "ğŸ”„ å†³ç­–: éƒ¨åˆ†ç¼“å­˜æ„å»º"
          elif [ $CACHE_SCORE -ge 20 ]; then
            BUILD_STRATEGY="minimal-cache"
            USE_INCREMENTAL="false"
            CLEAN_LEVEL="selective"
            THREADS=$(( $(nproc) < 4 ? $(nproc) : 4 ))
            echo "ğŸ”¨ å†³ç­–: æœ€å°ç¼“å­˜æ„å»º"
          else
            BUILD_STRATEGY="no-cache"
            USE_INCREMENTAL="false"
            CLEAN_LEVEL="aggressive"
            THREADS=2
            echo "ğŸš¨ å†³ç­–: æ— ç¼“å­˜ç´§æ€¥æ„å»º"
          fi

          # è¾“å‡ºå†³ç­–ç»“æœ
          echo "use-incremental=$USE_INCREMENTAL" >> $GITHUB_OUTPUT
          echo "build-strategy=$BUILD_STRATEGY" >> $GITHUB_OUTPUT
          echo "clean-level=$CLEAN_LEVEL" >> $GITHUB_OUTPUT
          echo "optimal-threads=$THREADS" >> $GITHUB_OUTPUT
          echo "needs-rebuild=false" >> $GITHUB_OUTPUT

          echo "::endgroup::"

  build:
    name: ğŸš€ æ™ºèƒ½æ„å»º
    needs: analyze
    runs-on: ubuntu-24.04
    if: always()
    env:
      DEBIAN_FRONTEND: noninteractive
    steps:
      - name: ğŸ›’ ç­¾å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–
        run: |
          echo "========== å®‰è£…å‰ç£ç›˜ç©ºé—´ =========="
          df -h

          # å®‰è£…ä¾èµ–ï¼ˆåŸºäº build.ymlï¼‰
          sudo -E apt-get -qq install -y ack antlr3 asciidoc autoconf automake autopoint \
            binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler \
            ecj fastjar flex gawk gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged \
            help2man intltool lib32gcc-s1 libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev \
            libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev \
            libpython3-dev libreadline-dev libssl-dev libtool lld llvm lrzsz mkisofs msmtp \
            ninja-build p7zip p7zip-full patch pkgconf python3 python3-pip python3-ply \
            python3-pyelftools python3-setuptools qemu-utils re2c rsync scons squashfs-tools \
            subversion swig texinfo uglifyjs unzip upx-ucl wget xmlto xxd zlib1g-dev \
            rustc cargo golang-go

          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

          echo "========== å®‰è£…åç£ç›˜ç©ºé—´ =========="
          df -h

      - name: âš™ï¸ Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        if: steps.analyze.outputs.disk-space != 'critical'
        with:
          key: ${{ env.CONFIG_FILE }}
          max-size: ${{ needs.analyze.outputs.disk-space == 'sufficient' && '8G' || needs.analyze.outputs.disk-space == 'medium' && '4G' || '2G' }}
          save: true

      - name: ğŸ“¥ æ£€æŸ¥æ„å»ºç¼“å­˜
        if: needs.analyze.outputs.disk-space != 'critical'
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/build_dir/host
            ${{ env.SOURCE_DIR }}/build_dir/toolchain-*
          key: ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-${{ needs.analyze.outputs.config-hash }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-

      - name: æºç å’Œä¾èµ–å‡†å¤‡
        timeout-minutes: 25
        run: |
          set -e
          echo "ğŸ“¥ å‡†å¤‡æºç å’Œä¾èµ–..."

          # æ˜¾ç¤ºç£ç›˜çŠ¶æ€
          echo "ğŸ’¾ å½“å‰ç£ç›˜çŠ¶æ€:"
          df -h

          # ccache ä¼˜åŒ– - æ›´æ¿€è¿›çš„é…ç½®
          if [ "${{ needs.analyze.outputs.disk-space }}" != "critical" ]; then
            ccache --set-config=compression=true --set-config=compression_level=6
            ccache --set-config=sloppiness=file_macro,time_macros,include_file_mtime,include_file_ctime,pch_defines,locale
            ccache --set-config=max_size=8G
            ccache --set-config=depend_mode=true
          fi

          # å…‹éš†æˆ–æ›´æ–°æºç 
          if [ -d "$SOURCE_DIR/.git" ]; then
            echo "æºç ç›®å½•å·²å­˜åœ¨ï¼Œæ›´æ–°ä¸­..."
            cd $SOURCE_DIR
            git fetch origin $REPO_BRANCH --depth=1
            git reset --hard origin/$REPO_BRANCH
            git clean -fd
          else
            echo "é¦–æ¬¡å…‹éš†æºç ..."
            rm -rf $SOURCE_DIR
            git config --global http.postBuffer 1048576000
            git clone -b $REPO_BRANCH --single-branch --depth=1 $REPO_URL $SOURCE_DIR
            cd $SOURCE_DIR
          fi

          # é…ç½®feeds
          if [ -f "$GITHUB_WORKSPACE/feeds.conf.default" ]; then
            cp "$GITHUB_WORKSPACE/feeds.conf.default" ./feeds.conf.default
          else
            # åˆ›å»ºåŸºç¡€feedsé…ç½®
            cat > feeds.conf.default << 'EOF'
          src-git packages https://github.com/immortalwrt/packages.git;openwrt-24.10
          src-git luci https://github.com/immortalwrt/luci.git;openwrt-24.10
          src-git routing https://github.com/openwrt/routing.git;openwrt-24.10
          src-git telephony https://github.com/openwrt/telephony.git;openwrt-24.10
          EOF
          fi

          # åŠ¨æ€æ·»åŠ feeds
          grep -q "qmodem" feeds.conf.default || echo 'src-git qmodem https://github.com/FUjr/QModem.git;main' >> feeds.conf.default
          grep -q "mihomo" feeds.conf.default || echo 'src-git mihomo https://github.com/morytyann/OpenWrt-mihomo.git;main' >> feeds.conf.default

          # æ ¹æ®ç£ç›˜ç©ºé—´è°ƒæ•´feedsæ›´æ–°ç­–ç•¥
          if [ "${{ needs.analyze.outputs.disk-space }}" = "critical" ]; then
            echo "ğŸš¨ ç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³ï¼Œæœ€å°åŒ–feedsæ›´æ–°..."
            timeout 180 ./scripts/feeds update -a || echo "âš ï¸ feedsæ›´æ–°å¤±è´¥"
            timeout 180 ./scripts/feeds install -a || echo "âš ï¸ feedså®‰è£…å¤±è´¥"
          else
            echo "ğŸ“Š æ›´æ–°feeds..."
            ./scripts/feeds update -a
            ./scripts/feeds install -a -f
          fi

          echo "âœ… æºç å’Œä¾èµ–å‡†å¤‡å®Œæˆ"

      - name: ğŸ”§ ä¿®å¤ä¾èµ–å’Œè¡¥ä¸
        run: |
          cd $SOURCE_DIR
          echo "ğŸ”§ åº”ç”¨ä¿®å¤è¡¥ä¸..."

          # å…‹éš†é¢å¤–è½¯ä»¶åŒ…ï¼ˆåŸºäº build.ymlï¼‰
          echo "å…‹éš†é¢å¤–è½¯ä»¶åŒ…..."

          # å…‹éš† luci-app-adguardhome (å¦‚æœä¸å­˜åœ¨)
          [ ! -d "package/luci-app-adguardhome" ] && \
            git clone --depth=1 https://github.com/rufengsuixing/luci-app-adguardhome.git package/luci-app-adguardhome

          # ä¿®å¤ luci-app-adguardhome çš„å®‰è£…è„šæœ¬ï¼ˆ/usr/bin/AdGuardHome è·¯å¾„å†²çªé—®é¢˜ï¼‰
          AGH_LUCI_SCRIPT="package/luci-app-adguardhome/root/usr/share/AdGuardHome/links.sh"
          if [ -f "$AGH_LUCI_SCRIPT" ]; then
            sed -i 's|mv /usr/bin/AdGuardHome/AdGuardHome|rm -rf /usr/bin/AdGuardHome 2>/dev/null; mkdir -p /usr/bin/AdGuardHome; mv /tmp/AdGuardHomeupdate/AdGuardHome_linux_*/AdGuardHome|g' "$AGH_LUCI_SCRIPT" || true
          fi

          # ä¿®å¤ AdGuardHome åˆå§‹åŒ–è„šæœ¬
          AGH_LUCI_INIT="package/luci-app-adguardhome/root/etc/init.d/AdGuardHome"
          if [ -f "$AGH_LUCI_INIT" ]; then
            sed -i '/^#!/a\
          [ -f /usr/bin/AdGuardHome ] && rm -f /usr/bin/AdGuardHome && mkdir -p /usr/bin/AdGuardHome' "$AGH_LUCI_INIT" || true
          fi

          # ç§»é™¤é—®é¢˜åŒ…
          rm -rf package/feeds/packages/{exim,onionshare-cli,python-zope-event,python-zope-interface} 2>/dev/null || true

          # QModem ä¿®å¤
          rm -rf package/feeds/qmodem/ndisc6 2>/dev/null || true
          QMODEM_MK="package/feeds/qmodem/qmodem/Makefile"
          [ -f "$QMODEM_MK" ] && sed -i 's/DEPENDS:=.*+kmod-mhi-wwan/# &/g' "$QMODEM_MK" || true

          # mt_hwifi ä¾èµ–ä¿®å¤
          MT_HWIFI_MK="package/mtk/drivers/mt_hwifi/Makefile"
          [ -f "$MT_HWIFI_MK" ] && sed -i 's/+kmod-mt_wifi_osal//g' "$MT_HWIFI_MK" || true

          echo "âœ… è¡¥ä¸åº”ç”¨å®Œæˆ"

      - name: é…ç½®æ„å»º
        run: |
          cd $SOURCE_DIR
          echo "âš™ï¸ é…ç½®æ„å»ºé€‰é¡¹..."

          # éªŒè¯äº’æ–¥é€‰é¡¹
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ] && [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            echo "âŒ é”™è¯¯: ä¸èƒ½åŒæ—¶å¯ç”¨ QModem Next å’Œ QModemï¼"
            exit 1
          fi

          # ä¸‹è½½åŸºç¡€é…ç½®
          echo "ğŸ“¥ ä¸‹è½½è¿œç¨‹é»˜è®¤é…ç½®..."

          # å°è¯•ä¸‹è½½è¿œç¨‹é…ç½®
          if curl -fsSL "$CONFIG_URL" -o base.config; then
            echo "âœ… è¿œç¨‹é…ç½®ä¸‹è½½æˆåŠŸ"
            cat base.config > .config
          elif [ -f "defconfig/mt7987_mt7992.config" ]; then
            echo "âœ… ä½¿ç”¨æœ¬åœ°é»˜è®¤é…ç½®"
            cp defconfig/mt7987_mt7992.config .config
          else
            echo "âš ï¸ è¿œç¨‹é…ç½®ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºæœ€å°é…ç½®..."
            cat > .config << 'EOF'
# ImmortalWrt MT7987 MT7992 åŸºç¡€é…ç½®
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y
CONFIG_TARGET_mediatek_filogic_DEVICE_CMCC_h5000m=y
CONFIG_TARGET_BOARD="mediatek"
CONFIG_TARGET_ARCH_PACKAGES="mt7987"
CONFIG_TARGET_KERNEL_PARTSIZE=32
CONFIG_TARGET_ROOTFS_PARTSIZE=1024

# åŸºç¡€ç½‘ç»œé…ç½®
CONFIG_IPV6=y
CONFIG_USE_APK=y
CONFIG_USE_SELINUX=n

# åŸºç¡€åŒ…
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_kmod-usb-storage=y
CONFIG_PACKAGE_kmod-usb-ohci=y
CONFIG_PACKAGE_kmod-usb-uhci=y
CONFIG_PACKAGE_kmod-usb2=y

# ç½‘ç»œæ”¯æŒ
CONFIG_PACKAGE_kmod-net-core=y
CONFIG_PACKAGE_kmod-ether=y
CONFIG_PACKAGE_kmod-at803x=y
CONFIG_PACKAGE_kmod-mt7915e=y
CONFIG_PACKAGE_kmod-mt7981-firmware=y
CONFIG_PACKAGE_kmod-mt7986-firmware=y

# æ–‡ä»¶ç³»ç»Ÿ
CONFIG_PACKAGE_kmod-fs-ext4=y
CONFIG_PACKAGE_kmod-fs-vfat=y
CONFIG_PACKAGE_kmod-fs-ntfs=y

# åŸºç¡€å·¥å…·
CONFIG_PACKAGE_iperf3=y
CONFIG_PACKAGE_ip6tables=y
CONFIG_PACKAGE_iptables=y
CONFIG_PACKAGE_ip-full=y
CONFIG_PACKAGE_firewall=y
CONFIG_PACKAGE_odhcp6c=y
CONFIG_PACKAGE_odhcpd-ipv6only=y
CONFIG_PACKAGE_opkg=y
CONFIG_PACKAGE_uhttpd=y
CONFIG_PACKAGE_uclient-fetch=y
CONFIG_PACKAGE_logd=y
CONFIG_PACKAGE_parted=y
CONFIG_PACKAGE_blkid=y
CONFIG_PACKAGE_wpad-basic=y

# åŸºç¡€Luci
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-app-firewall=y
CONFIG_PACKAGE_luci-app-opkg=y
CONFIG_PACKAGE_luci-app-statistics=y
CONFIG_PACKAGE_luci-compat=y
CONFIG_PACKAGE_luci-lib-ipkg=y
CONFIG_PACKAGE_luci-mod-admin-full=y
CONFIG_PACKAGE_luci-proto-ipv6=y

# ä¸»é¢˜
CONFIG_PACKAGE_luci-theme-bootstrap=y

EOF
          fi

          echo "âœ… åŸºç¡€é…ç½®åŠ è½½å®Œæˆ"

          # åº”ç”¨é¢å¤–é…ç½®
          if [ -f "$GITHUB_WORKSPACE/h5000m.extra.config" ]; then
            echo "ğŸ“‹ åº”ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶..."
            cat "$GITHUB_WORKSPACE/h5000m.extra.config" >> .config
            echo "âœ… è‡ªå®šä¹‰é…ç½®åº”ç”¨å®Œæˆ"
          fi

          # é…ç½®å‡½æ•°
          enable_pkg() { echo "CONFIG_PACKAGE_$1=y" >> .config; }
          disable_pkg() { echo "# CONFIG_PACKAGE_$1 is not set" >> .config; }

          # åº”ç”¨ç”¨æˆ·è¾“å…¥é…ç½®
          echo "âš™ï¸ åº”ç”¨ç”¨æˆ·é…ç½®..."

          # AdGuardHome
          if [ "${{ inputs.enable_adguardhome }}" = "true" ]; then
            echo "âœ… å¯ç”¨ AdGuardHome"
            enable_pkg "luci-app-adguardhome"
            enable_pkg "adguardhome"
          fi

          # OpenClash
          if [ "${{ inputs.enable_openclash }}" = "true" ]; then
            echo "âœ… å¯ç”¨ OpenClash"
            enable_pkg "luci-app-openclash"
            enable_pkg "bash"
            enable_pkg "dnsmasq-full"
            enable_pkg "curl"
            enable_pkg "ca-bundle"
            enable_pkg "ip-full"
            enable_pkg "kmod-nft-tproxy"
            enable_pkg "luci-compat"
          else
            disable_pkg "luci-app-openclash"
          fi

          # Mihomo
          if [ "${{ inputs.enable_mihomo }}" = "true" ]; then
            echo "âœ… å¯ç”¨ Mihomo"
            enable_pkg "mihomo"
            enable_pkg "luci-app-mihomo"
          else
            disable_pkg "mihomo"
            disable_pkg "luci-app-mihomo"
          fi

          # UPnP
          if [ "${{ inputs.enable_upnp }}" = "true" ]; then
            echo "âœ… å¯ç”¨ UPnP"
            enable_pkg "luci-app-upnp"
          else
            disable_pkg "luci-app-upnp"
          fi

          # VLMCSd
          if [ "${{ inputs.enable_vlmcsd }}" = "true" ]; then
            echo "âœ… å¯ç”¨ VLMCSd"
            enable_pkg "vlmcsd"
            enable_pkg "luci-app-vlmcsd"
          else
            disable_pkg "vlmcsd"
            disable_pkg "luci-app-vlmcsd"
          fi

          # MosDNS
          if [ "${{ inputs.enable_mosdns }}" = "true" ]; then
            echo "âœ… å¯ç”¨ MosDNS"
            enable_pkg "mosdns"
            enable_pkg "luci-app-mosdns"
          else
            disable_pkg "mosdns"
            disable_pkg "luci-app-mosdns"
          fi

          # DockerMan
          if [ "${{ inputs.enable_dockerman }}" = "true" ]; then
            echo "âœ… å¯ç”¨ DockerMan"
            enable_pkg "docker"
            enable_pkg "luci-app-dockerman"
          else
            disable_pkg "docker"
            disable_pkg "luci-app-dockerman"
          fi

          # QModem (äº’æ–¥å¤„ç†)
          if [ "${{ inputs.enable_qmodem_next }}" = "true" ]; then
            echo "âœ… å¯ç”¨ QModem Next"
            enable_pkg "luci-app-qmodem-next"
            disable_pkg "luci-app-qmodem"
          elif [ "${{ inputs.enable_qmodem }}" = "true" ]; then
            echo "âœ… å¯ç”¨ QModem"
            enable_pkg "luci-app-qmodem"
            disable_pkg "luci-app-qmodem-next"
          else
            disable_pkg "luci-app-qmodem"
            disable_pkg "luci-app-qmodem-next"
          fi

          # MWAN
          if [ "${{ inputs.enable_mwan }}" = "true" ]; then
            echo "âœ… å¯ç”¨ MWAN"
            enable_pkg "mwan3"
            enable_pkg "luci-app-mwan3"
          else
            disable_pkg "mwan3"
            disable_pkg "luci-app-mwan3"
          fi

          # æ·»åŠ ç¼–è¯‘ä¼˜åŒ–é…ç½®
          echo "ğŸ”§ æ·»åŠ ç¼–è¯‘ä¼˜åŒ–é…ç½®..."
          cat >> .config << 'EOF'

# ============================================================================
# ç¼–è¯‘ä¼˜åŒ–é…ç½®
# ============================================================================
CONFIG_CCACHE=y
CONFIG_DEVEL=y
CONFIG_BUILD_LOG=y
CONFIG_KERNEL_BUILD_USER="builder"
CONFIG_KERNEL_BUILD_DOMAIN="github.actions"

EOF

          echo "âœ… æ‰€æœ‰é…ç½®åº”ç”¨å®Œæˆ"

          # è¿è¡Œdefconfigç¡®ä¿é…ç½®æœ‰æ•ˆ
          echo "ğŸ”§ è¿è¡Œdefconfig..."
          make defconfig
          echo "âœ… é…ç½®å®Œæˆ"

      - name: ğŸ§¹ æ™ºèƒ½ç£ç›˜æ¸…ç†ï¼ˆæ„å»ºä¸­ï¼‰
        run: |
          echo "ğŸ§¹ æ„å»ºä¸­ç£ç›˜çŠ¶æ€æ£€æŸ¥..."
          df -h

          # å¦‚æœç£ç›˜ç©ºé—´ä»ç„¶ç´§å¼ ï¼Œè¿›è¡Œç´§æ€¥æ¸…ç†
          AVAILABLE_SPACE=$(df / | awk 'NR==2 {print $4}')
          AVAILABLE_GB=$((AVAILABLE_SPACE / 1024 / 1024))

          if [ $AVAILABLE_GB -lt 10 ]; then
            echo "ğŸš¨ ç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³ï¼Œæ‰§è¡Œç´§æ€¥æ¸…ç†..."

            # æ¸…ç†pipç¼“å­˜
            pip cache purge 2>/dev/null || true
            rm -rf ~/.cache/pip 2>/dev/null || true

            # æ¸…ç†npmç¼“å­˜
            npm cache clean --force 2>/dev/null || true
            rm -rf ~/.npm 2>/dev/null || true

            # æ¸…ç†å…¶ä»–ä¸´æ—¶ç›®å½•
            rm -rf ~/.cache 2>/dev/null || true
            rm -rf /tmp/* 2>/dev/null || true

            echo "ğŸ§¹ ç´§æ€¥æ¸…ç†å®Œæˆ"
            df -h
          fi

      - name: ğŸ”¨ æ™ºèƒ½ç¼–è¯‘
        timeout-minutes: ${{ inputs.max_build_time }}
        run: |
          cd $SOURCE_DIR
          THREADS=${{ needs.analyze.outputs.optimal-threads }}
          export PATH="/usr/lib/ccache:$PATH"

          echo "ğŸ”¨ å¼€å§‹æ„å»º (æ¨¡å¼: ${{ needs.analyze.outputs.build-strategy }})..."
          START_TIME=$(date +%s)

          # æ™ºèƒ½æ¸…ç†ï¼ˆæ ¹æ®ç£ç›˜ç©ºé—´è°ƒæ•´ï¼‰
          case "${{ needs.analyze.outputs.clean-level }}" in
            "aggressive")
              echo "ğŸ§¹ æ¿€è¿›æ¸…ç†æ¨¡å¼ï¼Œé‡Šæ”¾æœ€å¤§ç©ºé—´..."
              make clean
              rm -rf build_dir/* tmp staging_dir/target-*
              ;;
            "selective")
              echo "ğŸ§¹ é€‰æ‹©æ€§æ¸…ç†..."
              rm -rf build_dir/target-* build_dir/hostpkg
              ;;
            "minimal")
              echo "ğŸ§¹ æœ€å°æ¸…ç†..."
              rm -rf build_dir/target-* 2>/dev/null || true
              ;;
            "none")
              echo "âœ… è·³è¿‡æ¸…ç†"
              ;;
          esac

          # ä¸‹è½½ä¾èµ–
          if [ ! "$(ls -A dl 2>/dev/null)" ] || [ "${{ needs.analyze.outputs.use-incremental }}" != "true" ]; then
            echo "ğŸ“¦ ä¸‹è½½ä¾èµ–..."
            make download -j$THREADS || {
              find dl -size -1024c -delete 2>/dev/null || true
              make download -j$THREADS || echo "ä¸‹è½½å¤±è´¥ï¼Œç»§ç»­å°è¯•ç¼–è¯‘"
            }
          fi

          # æ ¹æ®ç­–ç•¥ç¼–è¯‘
          if [ "${{ needs.analyze.outputs.use-incremental }}" = "true" ]; then
            echo "âš¡ å¢é‡ç¼–è¯‘æ¨¡å¼..."
            make -j$THREADS BUILD_LOG=1 IGNORE_ERRORS=m || {
              echo "âš ï¸ å¢é‡ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å®Œæ•´ç¼–è¯‘..."
              make -j$THREADS BUILD_LOG=1
            }
          else
            if [ "${{ needs.analyze.outputs.disk-space }}" = "critical" ]; then
              echo "ğŸš¨ ç´§æ€¥ç¼–è¯‘æ¨¡å¼ï¼ˆå•çº¿ç¨‹ï¼‰..."
              make -j1 BUILD_LOG=1 || {
                echo "âŒ ç¼–è¯‘å¤±è´¥"
                exit 1
              }
            else
              echo "ğŸ”¨ å®Œæ•´ç¼–è¯‘æ¨¡å¼..."
              make -j$THREADS BUILD_LOG=1 IGNORE_ERRORS=m || {
                echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹..."
                make -j1 V=s || {
                  echo "âŒ ç¼–è¯‘å¤±è´¥"
                  exit 1
                }
              }
            fi
          fi

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "âœ… ç¼–è¯‘å®Œæˆ (è€—æ—¶: ${DURATION}s)"

      - name: ğŸ“¥ ä¿å­˜æ„å»ºç¼“å­˜
        if: always() && needs.analyze.outputs.disk-space != 'critical'
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.SOURCE_DIR }}/dl
            ${{ env.SOURCE_DIR }}/staging_dir/host
            ${{ env.SOURCE_DIR }}/staging_dir/toolchain-*
            ${{ env.SOURCE_DIR }}/build_dir/host
            ${{ env.SOURCE_DIR }}/build_dir/toolchain-*
          key: ${{ runner.os }}-build-${{ env.CONFIG_FILE }}-${{ needs.analyze.outputs.config-hash }}-${{ github.run_id }}

      - name: ğŸ“¦ æ”¶é›†äº§ç‰©
        if: success()
        run: |
          cd $SOURCE_DIR

          if [ ! -d "bin/targets" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç¼–è¯‘è¾“å‡º"
            exit 1
          fi

          mkdir -p $GITHUB_WORKSPACE/artifacts
          find bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp {} $GITHUB_WORKSPACE/artifacts/ \;

          # éªŒè¯äº§ç‰©
          if [ -z "$(ls -A $GITHUB_WORKSPACE/artifacts/ 2>/dev/null)" ]; then
            echo "âŒ æ²¡æœ‰æ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
            exit 1
          fi

          # ç”Ÿæˆæ¸…å•
          cat > $GITHUB_WORKSPACE/artifacts/MANIFEST.txt << 'EOF'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘    ImmortalWrt H5000M æ·±åº¦æ¸…ç†æ„å»ºæŠ¥å‘Š         â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“… æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}
          ğŸ·ï¸  Build #: ${{ github.run_number }}

          ğŸ¯ æ„å»ºç­–ç•¥: ${{ needs.analyze.outputs.build-strategy }}
          âš¡ å¢é‡æ¨¡å¼: ${{ needs.analyze.outputs.use-incremental }}
          ğŸ’¾ æ¸…ç†çº§åˆ«: ${{ needs.analyze.outputs.clean-level }}
          ğŸ”§ ä¼˜åŒ–çº¿ç¨‹: ${{ needs.analyze.outputs.optimal-threads }}

          ğŸ’¾ ç£ç›˜ç­–ç•¥: ${{ needs.analyze.outputs.disk-space }}
          ğŸ§¹ æ¸…ç†æ¨¡å¼: æ·±åº¦æ¸…ç† + æ™ºèƒ½ç¼“å­˜ç®¡ç†

          âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:
          â€¢ AdGuardHome: ${{ inputs.enable_adguardhome }}
          â€¢ OpenClash: ${{ inputs.enable_openclash }}
          â€¢ Mihomo: ${{ inputs.enable_mihomo }}
          â€¢ UPnP: ${{ inputs.enable_upnp }}
          â€¢ VLMCSd: ${{ inputs.enable_vlmcsd }}
          â€¢ MosDNS: ${{ inputs.enable_mosdns }}
          â€¢ DockerMan: ${{ inputs.enable_dockerman }}
          â€¢ QModem Next: ${{ inputs.enable_qmodem_next }}
          â€¢ QModem: ${{ inputs.enable_qmodem }}
          â€¢ MWAN: ${{ inputs.enable_mwan }}

          ğŸ“¦ äº§ç‰©æ–‡ä»¶:
          EOF

          cd $GITHUB_WORKSPACE/artifacts
          ls -lh *.bin *.img.gz 2>/dev/null | awk '{print "  â€¢ " $9 " (" $5 ")"}' >> MANIFEST.txt || echo "  (æ— äº§ç‰©æ–‡ä»¶)" >> MANIFEST.txt

          echo "âœ… äº§ç‰©æ”¶é›†å®Œæˆ:"
          ls -lh

      - name: ğŸš€ ä¸Šä¼ æ„å»ºç»“æœ
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ImmortalWrt-H5000M-${{ github.run_number }}
          path: artifacts/
          retention-days: 10

      - name: ğŸ‰ åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          tag_name: v${{ github.run_number }}
          name: ImmortalWrt H5000M #${{ github.run_number }} [${{ needs.analyze.outputs.build-strategy }}]
          body: |
            ğŸ‰ **ImmortalWrt H5000M å›ºä»¶å·²æ„å»ºå®Œæˆ**

            ğŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
            ğŸ”— è¿è¡Œ ID: ${{ github.run_id }}

            **ğŸ¯ æ„å»ºä¿¡æ¯:**
            - ç­–ç•¥: ${{ needs.analyze.outputs.build-strategy }}
            - ä¼˜åŒ–: ${{ needs.analyze.outputs.use-incremental == 'true' && 'å¢é‡' || 'å®Œæ•´' }}
            - çº¿ç¨‹: ${{ needs.analyze.outputs.optimal-threads }}
            - ç£ç›˜ç­–ç•¥: ${{ needs.analyze.outputs.disk-space }}

            **âš™ï¸ å¯ç”¨çš„åŠŸèƒ½:**
            - AdGuardHome: ${{ inputs.enable_adguardhome }}
            - OpenClash: ${{ inputs.enable_openclash }}
            - Mihomo: ${{ inputs.enable_mihomo }}
            - UPnP: ${{ inputs.enable_upnp }}
            - VLMCSd: ${{ inputs.enable_vlmcsd }}
            - MosDNS: ${{ inputs.enable_mosdns }}
            - Docker: ${{ inputs.enable_dockerman }}
            - MWAN: ${{ inputs.enable_mwan }}

            ğŸ’¾ ä¸‹è½½äº§ç‰©: è§ä¸‹æ–¹ Artifacts
            ğŸ“‹ è¯¦ç»†ä¿¡æ¯: è§ MANIFEST.txt
          prerelease: false
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}